<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.css">
    <!-- Local bootstrap.js-->
    <script src="../bootstrap-5.3.2-dist/js/bootstrap.js"></script>
</head>

<body>
    <div id="customAppointmentAlert" class="custom-alert nodisplay">
        <h2>Appointment registered successfully</h2>
    </div>
    <div class="container">
        <div class="row justify-content-center text-white mt-4">
            <div class="col-md-6 bg-light p-4 rounded">
                <h1 class="text-center mb-3">Appointment Booking</h1>
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="repairType">Type of Repair</label>
                        <select class="form-control" id="repairType" name="repairType" required
                            onchange="changeTimeContainer([false]*9)">
                            <option tabindex="1" value="1">Oil change</option>
                            <option tabindex="2" value="120">Paint job</option>
                            <option tabindex="3" value="4">Overall checkup or tuning</option>
                            <option tabindex="4" value="4">Custom parts</option>
                            <option tabindex="5" value="1">Project discussion</option>
                        </select>
                    </div>
                    <label for="repairType" class="text-white">Choose a day</label>
                    <div class="container text-dark">
                        <div class="row justify-content-center ">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header row">
                                        <button id="prevMonth" class="btn btn-outline-secondary m-auto">&lt;</button>
                                        <h3 tabindex=0 id="monthYear" class="m-auto"></h3>
                                        <button id="nextMonth" class="btn btn-outline-secondary m-auto">&gt;</button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row" id="daysOfWeek">
                                            <!-- Days of the week will be appended here -->
                                        </div>
                                        <div class="row" id="calendar">
                                            <!-- Calendar will be appended here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="selectable" id="time-container">
                        <!-- Choices for time will dynamically appear here-->
                    </div>
                    <div class="form-group mt-2">
                        <label class="form-label" for="additionalInfo">Additional Information</label>
                        <textarea class="form-control" id="additionalInfo" name="additionalInfo" rows="1"
                            placeholder="Enter any additional information about the appointment"
                            maxlength="255"></textarea>
                    </div>
                    <div class="">
                        <button type="submit" class="btn btn-outline-secondary ">Make Appointment</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        let selectedDateTime = null; // Variable to store the selected datetime
        let selectedDate = null; // Variable to store the selected date
        let user = null;
        const loggedUser = JSON.parse(getCookie("userData"));
        console.log("Logged: ", loggedUser);
        document.getElementById('appointmentForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission
            // Retrieve form data
            const additionalInfo = document.getElementById('additionalInfo').value;
            // Fetch user information from the server
            fetch('http://localhost:5001/user-info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    UUID: loggedUser.UUID
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update the profile information on the page
                        user = data.user.idUser;

                        const repairTypeSelect = document.getElementById('repairType');
                        const repairTypeDuration = parseInt(repairTypeSelect.value); // Convert the value to an integer
                        if (repairTypeDuration < 120) {
                            endDateTime = new Date(selectedDateTime.getTime());

                        }
                        else {

                            selectedDate.setHours(selectedDate.getHours() + 9);
                            selectedDateTime = new Date(selectedDate);
                            selectedDate.setHours(selectedDate.getHours() + 6);
                            endDateTime = new Date(selectedDate.getTime());

                        }
                        // Add the specified number of hours to the selected date time
                        endDateTime.setHours(endDateTime.getHours() + repairTypeDuration);

                        console.log('Selected Repair Type Duration:', repairTypeDuration);
                        console.log('Selected Repair will end:', endDateTime);
                        // Construct the data object to send to the backend
                        const requestData = {
                            idUser: user,
                            StartDate: selectedDateTime,
                            EndDateProjection: endDateTime,
                            ProjectInfo: additionalInfo
                        };
                        console.log(requestData)
                        // Fetch request to send form data to backend
                        fetch(window.location.origin + ':5001' + '/make-appointment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json' // Specify JSON content type
                            },
                            body: JSON.stringify(requestData)
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Appointment created successfully:', data);
                                showCustomAppointmentAlert();

                            })
                            .catch(error => {
                                console.error('Error creating appointment:', error);
                            });
                    } else {
                        console.error('Error fetching user information:', data.message);
                    }
                })

                .catch(error => {
                    console.error('Error fetching user information:', error);
                });

            console.log(`User:${user}`)

        });

        // Function to generate buttons based on availability
        function generateTimeButtons(hours,FreeHoursArray, RepairType4 = false) {
            FreeHours = FreeHoursArray;
            return hours.map((hour, index) => {
                const hourIndex = hour - 9; // Calculate index in freeHoursArray
                console.log(hourIndex);
                console.log(FreeHours);
                if (FreeHours[hourIndex]) { // Check if hour is available
                    if(RepairType4){
                        return `<button type="button" class="btn-sm btn-outline-secondary time-button mb-1" id="${hour}" onclick="selectTime('${hour}')">${hour}:00-${hour+4}:00</button>`;
                    }
                    else{
                        return `<button type="button" class="btn-sm btn-outline-secondary time-button mb-1" id="${hour}" onclick="selectTime('${hour}')">${hour}:00-${hour+1}:00</button>`;
                    }
                } else {
                    return ''; // Return empty string if hour is not available
                }
            }).join('');
        }

        function changeTimeContainer(Array) {
            GetCalendarInfo();
            let FreeHours = Array;
            selectedDate = null;
            const repairType = document.getElementById('repairType').value;
            let timeContainerHTML = '';
            switch (repairType) {
                case '1':
                    timeContainerHTML = `
                    <label class="mt-4">Choose Appointment Time</label>
                        <div class="time-container text-white">
                            <div class="row">
                                <div class="col-12">
                                    <div class="m-auto">
                                        ${generateTimeButtons([9, 10, 11, 12, 13, 14, 15, 16, 17], FreeHours)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case '120':
                    timeContainerHTML = '';
                    break;
                case '4':
                    timeContainerHTML = `
                        <label class="mt-4">Choose Appointment Time</label>
                        <div class="time-container text-white">
                            <div class="row">
                                <div class="col-12">
                                    <div class="m-auto">
                                        ${generateTimeButtons([9, 14], FreeHours,true)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    break;
                default:
                    timeContainerHTML = '';
                    break;
            }
            document.getElementById('time-container').innerHTML = timeContainerHTML;
        }

        function selectTime(time) {
            // Logic to handle time selection
            console.log('Selected time:', time);
        }

        /* Scripts for calendar */
        const daysOfWeekElement = document.getElementById('daysOfWeek');
        const calendarElement = document.getElementById('calendar');
        const monthYearElement = document.getElementById('monthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        let currentDate = new Date();

        // Function to check if a day is full based on date ranges
        function GetCalendarInfo() {
            fetch(window.location.origin + ':5001' + '/all-project-dates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    MonthDisplay: currentDate.getMonth() + 1
                }),
            })
                .then(response => response.json())
                .then(data => {
                    // Starts rendering the calendar, taking into count which days cant be used because of the already exsisting projects
                    renderCalendar(data);
                })
                .catch(error => {
                    console.error('Error fetching user information:', error);
                });
        }

        // Determine available hours in the day
        function getAvailableHourlySlots(dayOfMonth, takenDateTimes) {
            // Define working hours
            const WORK_DAY_START = new Date();
            WORK_DAY_START.setDate(dayOfMonth);
            WORK_DAY_START.setHours(9, 0, 0, 0); // 9 AM
            const WORK_DAY_END = new Date();
            WORK_DAY_END.setDate(dayOfMonth);
            WORK_DAY_END.setHours(18, 0, 0, 0); // 6 PM

            // Create an array to store the intervals for the day
            const intervals = [];

            // Iterate through the date ranges
            takenDateTimes.forEach(({ StartDate, EndDateProjection }) => {
                let startDate = new Date(StartDate);
                let endDate = new Date(EndDateProjection);

                // Adjust for working hours
                if (startDate < WORK_DAY_START) startDate = WORK_DAY_START;
                if (endDate > WORK_DAY_END) endDate = WORK_DAY_END;

                if (startDate < endDate) {
                    intervals.push([startDate, endDate]);
                }
            });

            // Sort intervals by start time
            intervals.sort((a, b) => a[0] - b[0]);

            // Create an array to mark which hours are taken
            const FreeHourArray = new Array(9).fill(true); // 9 hours in the workday

            // Mark intervals
            intervals.forEach(([start, end]) => {
                // Ensure we are only working within the 9 AM to 6 PM window
                let intervalStart = Math.max(start, WORK_DAY_START);
                let intervalEnd = Math.min(end, WORK_DAY_END);
                const StartHour = new Date(intervalStart).getHours();
                const EndHour = new Date(intervalEnd).getHours();
                for (let hour = StartHour; hour < EndHour; hour++) {
                    if (hour >= 9 && hour < 18) { // Only consider working hours
                        FreeHourArray[hour - 9] = false; // Mark as taken
                    }
                }
            });

            return FreeHourArray;
        }

        function isDayFull(dayOfMonth, dateRanges) {
            // Define the working hours for a specific day
            const WORK_DAY_START = new Date();
            WORK_DAY_START.setDate(dayOfMonth);
            WORK_DAY_START.setHours(9, 0, 0, 0); // 9 AM
            WORK_DAY_START.setMinutes(0); // Ensure minutes are set to zero
            const WORK_DAY_END = new Date();
            WORK_DAY_END.setDate(dayOfMonth);
            WORK_DAY_END.setHours(18, 0, 0, 0); // 6 PM

            // Create an array to store the intervals for the day
            const intervals = [];

            // Iterate through the date ranges
            dateRanges.forEach(({ StartDate, EndDateProjection }) => {
                let startDate = new Date(StartDate);
                let endDate = new Date(EndDateProjection);

                // Adjust start and end times within working hours
                if (startDate < WORK_DAY_START) startDate = new Date(WORK_DAY_START);
                if (endDate > WORK_DAY_END) endDate = new Date(WORK_DAY_END);

                // Only add intervals that are within the working hours
                if (startDate <= endDate) {
                    intervals.push([startDate, endDate]);
                }
            });

            // Sort intervals by start time
            intervals.sort((a, b) => a[0] - b[0]);

            // Merge intervals and check if the full working day is covered
            let mergedEnd = WORK_DAY_START;

            for (const [start, end] of intervals) {
                if (start > mergedEnd) {
                    // There is a gap between the previous end and the current start
                    return false;
                }
                if (end > mergedEnd) {
                    mergedEnd = end;
                }
            }

            return mergedEnd >= WORK_DAY_END; //Checks if all the intervals combine pass or equal the work day end time, aka is it booked
        }



        function renderCalendar(TakenDateTimes) {
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const lastDayOfPrevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
            monthYearElement.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;
            // Clear previous calendar
            calendarElement.innerHTML = '';
            daysOfWeekElement.innerHTML = '';
            // Add days of the week, starting from Monday
            const daysOfWeek = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
            daysOfWeek.forEach(day => {
                const dayOfWeek = document.createElement('div');
                dayOfWeek.textContent = day;
                dayOfWeek.classList.add('font-weight-normal', 'text-center', 'small-font', 'ml-25', 'mr-25');
                daysOfWeekElement.appendChild(dayOfWeek);
            });
            let currentDay = 1;
            let currentMonthFinished = false;
            let dayOffset = (firstDayOfMonth.getDay() - 1 + 7) % 7; // Adjusted calculation for Monday as start of week
            // Iterate through the weeks
            while (!currentMonthFinished) {
                // Create a row for the week
                const weekRow = document.createElement('div');
                weekRow.classList.add('row', 'ml-1', 'mr-1');
                // Populate the row with days
                for (let i = 0; i < 7; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('day', 'text-center', 'btn', 'btn-outline-secondary', 'btn-sm', 'm-1', 'outline', 'col', 'p-1');
                    if ((i >= dayOffset || currentDay > 1) && currentDay <= lastDayOfMonth.getDate()) {
                        const dayOfMonth = currentDay;
                        dayCell.textContent = dayOfMonth;
                        dayCell.classList.add('currentMonth');
                        // Check if the day is weekend
                        const currentDateObject = new Date();
                        if (i === 5 || i === 6) { // Saturday or Sunday
                            dayCell.classList.add('disabled', 'weekend');
                            dayCell.classList.remove('btn-outline-secondary');
                        }
                        // Check if the day is before today
                        else if ((currentDate.getFullYear() < currentDateObject.getFullYear() ||
                            (currentDate.getFullYear() === currentDateObject.getFullYear() &&
                                currentDate.getMonth() < currentDateObject.getMonth())) ||
                            (currentDate.getFullYear() === currentDateObject.getFullYear() &&
                                currentDate.getMonth() === currentDateObject.getMonth() &&
                                dayOfMonth < currentDateObject.getDate())) {
                            dayCell.classList.add('disabled', 'prevDay');
                            dayCell.classList.remove('btn-outline-secondary');
                        }
                        // Check if day is already full
                        else if (TakenDateTimes && isDayFull(dayOfMonth, TakenDateTimes)) {
                            dayCell.classList.add('disabled', 'takenDay');
                            dayCell.classList.remove('btn-outline-secondary');
                        }

                        else {
                            // Add click event listener to each day cell
                            dayCell.addEventListener('click', () => {
                                document.querySelectorAll('.day').forEach(button => {
                                    button.classList.remove('active');
                                });
                                selectedDate = null;
                                const FreeHourArray = getAvailableHourlySlots(dayOfMonth, TakenDateTimes);
                                console.log(FreeHourArray);
                                openTimeMenuForDay(dayOfMonth, FreeHourArray);
                            });
                            // Add enter event listener to each day cell
                            dayCell.addEventListener('keydown', function (event) {
                                if (event.key === 'Enter') {
                                    // Check if the selected day is in the past
                                    document.querySelectorAll('.day').forEach(button => {
                                        button.classList.remove('active');
                                    });

                                    selectedDate = null;
                                    const FreeHourArray = getAvailableHourlySlots(dayOfMonth, takenDateTimes);
                                    openTimeMenuForDay(dayOfMonth, FreeHourArray);
                                }
                            });
                            dayCell.setAttribute('tabindex', '0');
                        }
                        currentDay++;
                    }
                    else if (currentDay < dayOffset) {
                        // Day is part of the previous month
                        dayCell.textContent = '';
                        dayCell.classList.add('prevMonth', 'disabled');
                        dayCell.classList.remove('btn-outline-secondary');
                    }
                    else if (currentDay >= lastDayOfMonth.getDay()) {
                        // Day is part of the next month
                        dayCell.textContent = '';
                        dayCell.classList.add('nextMonth', 'disabled');
                        dayCell.classList.remove('btn-outline-secondary');
                        currentDay++;
                    }
                    weekRow.appendChild(dayCell);
                }
                // Append the week row to the calendar
                calendarElement.appendChild(weekRow);
                // Check if we have finished rendering the current month
                if (currentDay > lastDayOfMonth.getDate()) {
                    currentMonthFinished = true;
                }
            }
        }




        function openTimeMenuForDay(day, array) {
            // Add the active class to the clicked button
            event.target.classList.add('active');
            availableTime = array;
            // Store the selected date
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            console.log('Selected date:', selectedDate);
            // If repair type is '120', select the next five days too
            const repairTypeSelect = document.getElementById('repairType');
            const repairTypeValue = repairTypeSelect.value;
            if (repairTypeValue === '120') {
                // Get the index of the clicked day button
                const dayButtons = document.querySelectorAll('.day');
                const clickedDayIndex = Array.from(dayButtons).indexOf(event.target);
                // Select the next five days
                for (let i = 0; i < 5; i++) {
                    if (clickedDayIndex + i < dayButtons.length) {
                        dayButtons[clickedDayIndex + i].classList.add('active');
                    }
                }
                // Show information about the selected date range
                const selectedDateRangeInfo = document.getElementById('time-container');
                if (selectedDateRangeInfo) {
                    const endDate = new Date(selectedDate);
                    endDate.setDate(endDate.getDate() + 5); // Add 5 days
                    selectedDateRangeInfo.innerHTML = `
                        <div tabindex="0" class="mt-4  ">
                            Selected Date Range: ${selectedDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}
                        </div>
                            `;
                }
            }
            changeTimeContainer(availableTime);
        }

        /* Scripts for showing time choosing options */
        function selectTime(hour) {
            if (selectedDate === null) {
                // If no date is selected, show an alert
                alert('Please select a day first.');
                return;
            }

            // Construct the selected datetime using the selected date and hour
            const selectedHour = parseInt(hour);
            selectedDateTime = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), selectedHour, 0, 0);
            console.log('Selected datetime:', selectedDateTime);

            // Update the time-container with the selected datetime
            const timeContainer = document.querySelector('.time-container');
            timeContainer.querySelectorAll('p.selected-time').forEach(element => {
                element.remove();
            });

            // Construct the HTML string for the selected time paragraph
            const selectedTimeHTML = `<p tabindex="0"  class="mt-2 selected-time">Selected Date & Time: ${selectedDate.toLocaleDateString()} ${selectedDateTime.getHours().toString().padStart(2, '0')}:${selectedDateTime.getMinutes().toString().padStart(2, '0')}</p>`;

            // Add the selected time paragraph to the timeContainer
            timeContainer.insertAdjacentHTML('beforeend', selectedTimeHTML);
        }




        prevMonthButton.addEventListener('click', () => {
            event.preventDefault();
            currentDate.setMonth(currentDate.getMonth() - 1);
            // Add checking already taken days in database to block their selection in render calendar 


            GetCalendarInfo();
        });
        nextMonthButton.addEventListener('click', () => {
            event.preventDefault();
            currentDate.setMonth(currentDate.getMonth() + 1);
            GetCalendarInfo();
        });

        document.addEventListener("DOMContentLoaded", function () {
            const repairTypeSelect = document.getElementById("repairType");

            repairTypeSelect.addEventListener("focus", function () {
                // Open the options
                this.click();
            });
        });

        // Initial render
        GetCalendarInfo();
        changeTimeContainer([false]*9); // Initial run of TimeContainer creation
    </script>

</body>

</html>
``